# src/speed_layer/streaming_toxicity.py

Viết Spark Structured Streaming job:
- Đọc từ Kafka topic "tiktok-raw"
- Parse JSON (schema như ingestion)
- Explode comments
- Sử dụng model ViHateT5-HSD để detect hate speech (label: HATE/OFFENSIVE/CLEAN)
- Aggregate trong window 5 phút: per video_id và hashtags → total_comments, toxic_comments, toxic_ratio
- Ghi kết quả vào PostgreSQL:
  - Table: speed_video_stats (upsert bằng video_id + window_end)
  - Table: speed_alerts nếu toxic_ratio > 0.7
- Checkpointing bắt buộc
- Watermarking xử lý late data
- Output mode: append hoặc complete tùy phù hợp
- Dùng JDBC sink