# sql/serving_views.sql

Viết các SQL views trong PostgreSQL để merge Batch + Speed:

CREATE TABLE speed_video_stats (...);
CREATE TABLE batch_video_stats (...);

-- Serving view ưu tiên Speed Layer (dữ liệu mới nhất)
CREATE OR REPLACE VIEW serving_video_stats AS
SELECT COALESCE(s.video_id, b.video_id) AS video_id,
       COALESCE(s.total_comments, b.total_comments) AS total_comments,
       COALESCE(s.toxic_comments, b.toxic_comments) AS toxic_comments,
       COALESCE(s.toxic_ratio, b.toxic_ratio) AS toxic_ratio,
       GREATEST(COALESCE(s.window_end, '1970-01-01'), b.computed_at) AS last_updated
FROM speed_video_stats s
FULL OUTER JOIN batch_video_stats b USING (video_id);

Tương tự cho:
- serving_hashtag_stats
- serving_user_ranking
- serving_alerts (chỉ từ speed)

Power BI sẽ connect vào các serving_* views này.